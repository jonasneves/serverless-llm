version: '3.8'

services:
  # Main chat server (needs Python + dependencies)
  chat-server:
    build:
      context: ./app/chat-interface
      dockerfile: Dockerfile
    container_name: chat-server
    environment:
      - PORT=8080
      - BASE_DOMAIN=${BASE_DOMAIN}
      # Legacy: Individual URLs (used if BASE_DOMAIN not set)
      - QWEN_API_URL=${QWEN_API_URL}
      - PHI_API_URL=${PHI_API_URL}
      - LLAMA_API_URL=${LLAMA_API_URL}
      - MISTRAL_API_URL=${MISTRAL_API_URL}
      - GEMMA_API_URL=${GEMMA_API_URL}
      - GH_MODELS_TOKEN=${GH_MODELS_TOKEN}
    ports:
      - "8080:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - chat-network

  cloudflared:
    build: ./docker/cloudflared
    container_name: chat-cloudflared
    command: ["tunnel", "--no-autoupdate", "run", "--token", "${CLOUDFLARE_TUNNEL_TOKEN_CHAT}"]
    depends_on:
      chat-server:
        condition: service_healthy
    restart: unless-stopped
    network_mode: host

networks:
  chat-network:
