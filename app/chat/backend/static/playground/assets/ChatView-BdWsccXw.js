import{r as l,j as e,Z as oe,t as Oe,u as Ne,v as be,T as ge,U as Ye,w as qe,x as Qe,y as Ge,p as De,z as Ze,X as Ve,D as Ue}from"./react-vendor-Cr2kZ6Hw.js";import{F as le}from"./FormattedContent-C59IBQBw.js";import{g as Ie,a as et,S as tt,P as rt,f as we,s as ve}from"./index-B9-HltV7.js";import"./markdown-BhL5aFst.js";import"./math-render-BeslBgx1.js";import"./syntax-highlight-xu6YVAlF.js";function ye(i,p){const A=Math.min(i.x,p.x),m=Math.min(i.y,p.y),x=Math.max(i.x,p.x),d=Math.max(i.y,p.y);return{left:A,top:m,right:x,bottom:d,width:x-A,height:d-m}}function st(i,p){return!(i.right<p.left||i.left>p.right||i.bottom<p.top||i.top>p.bottom)}function nt({containerRef:i,itemRefs:p,setSelectedIndices:A}){const[m,x]=l.useState(null),d=l.useRef(!1);l.useEffect(()=>{d.current=m!=null},[m]),l.useEffect(()=>{const S=h=>{if(h.button!==0||!i.current)return;const k=h.target;if(!k||k.closest('button, a, input, textarea, select, [role="button"]'))return;const c=i.current.getBoundingClientRect();if(!(h.clientX>=c.left&&h.clientX<=c.right&&h.clientY>=c.top&&h.clientY<=c.bottom))return;const w={x:h.clientX,y:h.clientY};h.preventDefault(),d.current=!0,x({origin:w,current:w,active:!1})};return window.addEventListener("mousedown",S,!0),()=>window.removeEventListener("mousedown",S,!0)},[i]),l.useEffect(()=>{if(!m||!i.current)return;const S=b=>b.preventDefault();document.addEventListener("selectstart",S);const h=b=>{const c={x:b.clientX,y:b.clientY};x(g=>{if(!g)return g;const w=ye(g.origin,c),H=g.active||w.width>2||w.height>2;return{...g,current:c,active:H}})},k=b=>{d.current=!1;const c={x:b.clientX,y:b.clientY};x(g=>{if(!g)return null;const w=ye(g.origin,c);if(g.active&&w.width>1&&w.height>1){const H=[];for(const[U,E]of p.current.entries()){const P=E.getBoundingClientRect();st({left:w.left,right:w.right,top:w.top,bottom:w.bottom},{left:P.left,right:P.right,top:P.top,bottom:P.bottom})&&H.push(U)}A(new Set(H))}return null})};return window.addEventListener("mousemove",h),window.addEventListener("mouseup",k),()=>{window.removeEventListener("mousemove",h),window.removeEventListener("mouseup",k),document.removeEventListener("selectstart",S)}},[m,i,p,A]);const R=l.useMemo(()=>{if(!m||!m.active||!i.current)return null;const S=i.current.getBoundingClientRect(),h=ye(m.origin,m.current);return h.width<=0||h.height<=0?null:{left:h.left-S.left,top:h.top-S.top,width:h.width,height:h.height}},[m,i]),$=l.useCallback(()=>{x(null),d.current=!1},[]);return{selectionRect:R,isSelecting:m!=null,dragSelectionActiveRef:d,clearSelection:$}}const ot=6e4;function lt(){const i=l.useRef(new Map),p=l.useRef(null),A=R=>{const $=i.current.get(R);return $?Date.now()-$<ot:!1};return{sortModels:R=>{const $=R.map(c=>({...c,priority:Ie(c.id,c.type||"self-hosted",c.priority),isRateLimited:A(c.id),isLastSuccessful:c.id===p.current})),S=$.filter(c=>!c.isRateLimited),h=$.filter(c=>c.isRateLimited),k=S.sort((c,g)=>c.isLastSuccessful!==g.isLastSuccessful?c.isLastSuccessful?-1:1:c.priority!==g.priority?c.priority-g.priority:c.type!==g.type?c.type==="self-hosted"?-1:1:c.id.localeCompare(g.id)),b=h.sort((c,g)=>c.priority!==g.priority?c.priority-g.priority:c.id.localeCompare(g.id));return[...k,...b]},recordRateLimit:R=>{i.current.set(R,Date.now())},recordSuccess:R=>{p.current=R,i.current.delete(R)},isRecentlyRateLimited:A,getLastSuccessfulModel:()=>p.current}}function at(i){const[p,A]=l.useState([]);return l.useEffect(()=>{const m=i.match(/```json\s*([\s\S]*?)\s*```/);if(m)try{let x=m[1];x=x.replace(/[\\']/g,'"').replace(/,\s*}/g,"}").replace(/,\s*]/g,"]").replace(/}\s*[\\]+\s*$/g,"}").replace(/"\s*"\s*$/g,"").trim();const d=JSON.parse(x);if(d.options&&Array.isArray(d.options)){const R=d.options.filter($=>$.id&&$.label&&$.value);R.length>0?A(R):A([])}}catch(x){console.error("Failed to parse gesture options:",x),A([])}else A([])},[i]),p}function je(i){return i.replace(/```json[\s\S]*?```/g,"").trim()}const it=1800;function ct({content:i,onSelect:p,isInline:A=!1}){const m=at(i),[x,d]=l.useState(null),[R,$]=l.useState({}),S=l.useRef(0),h=l.useRef(0);l.useEffect(()=>{const E=P=>{var z;const y=(z=P.detail)==null?void 0:z.target;if(y&&y.hasAttribute("data-gesture-option")){const T=y.getAttribute("data-gesture-option");T&&T!==x&&(d(T),k(T))}else x&&(d(null),b())};return window.addEventListener("gesture-hover",E),()=>{window.removeEventListener("gesture-hover",E),b()}},[x]);const k=E=>{b(),S.current=Date.now();const P=()=>{const y=Date.now()-S.current,z=Math.min(y/it*100,100);if($(T=>({...T,[E]:z})),z>=100){const T=m.find(K=>K.id===E);T&&(p(T.value),b())}else h.current=requestAnimationFrame(P)};h.current=requestAnimationFrame(P)},b=()=>{h.current&&cancelAnimationFrame(h.current),$({})},c=E=>{d(E),k(E)},g=()=>{d(null),b()};if(m.length===0)return null;const w=A?"w-full mt-3":"w-full",H=A?"grid grid-cols-2 gap-2":"flex flex-col gap-2.5",U=E=>A?`relative overflow-hidden rounded-lg font-medium text-xs border transition-all duration-200 text-center min-h-[40px] flex items-center justify-center px-3 py-2 ${E?"bg-blue-500/20 border-blue-500/50 text-white shadow-lg shadow-blue-500/10":"bg-slate-800/60 border-slate-700/60 text-slate-200 hover:bg-slate-800/80 hover:border-slate-700/80"}`:`relative overflow-hidden rounded-xl font-medium text-sm border transition-all duration-200 w-full text-left min-h-[52px] flex items-center px-4 py-3 ${E?"bg-blue-500/20 border-blue-500/50 text-white shadow-lg shadow-blue-500/10 scale-[1.02]":"bg-slate-800/60 border-slate-700/60 text-slate-200 hover:bg-slate-800/80 hover:border-slate-700/80"}`;return e.jsxs("div",{className:w,children:[!A&&e.jsxs("div",{className:"flex items-center gap-2 mb-3 px-1",children:[e.jsx("div",{className:"text-xs font-semibold uppercase tracking-wider text-slate-400",children:"Quick Actions"}),e.jsx("div",{className:"flex-1 h-px bg-gradient-to-r from-slate-700/50 to-transparent"})]}),e.jsx("div",{className:H,children:m.map(E=>{const P=R[E.id]||0,y=x===E.id;return e.jsxs("button",{onClick:()=>p(E.value),onMouseEnter:()=>c(E.id),onMouseLeave:g,"data-gesture-option":E.id,className:U(y),children:[y&&P>0&&e.jsx("div",{className:"absolute bottom-0 left-0 h-1 bg-gradient-to-r from-blue-400 to-blue-500 transition-all duration-75",style:{width:`${P}%`}}),e.jsx("span",{className:"relative z-10",children:E.label})]},E.id)})})]})}function ut({models:i,selectedModelId:p,onSelectModel:A,autoMode:m,setAutoMode:x,autoModeScope:d,setAutoModeScope:R,isGenerating:$}){const[S,h]=l.useState(null),[k,b]=l.useState(""),c=l.useRef(null),g=l.useRef(null),w=l.useMemo(()=>i.filter(a=>a.type==="self-hosted"),[i]),H=l.useMemo(()=>i.filter(a=>a.type==="github"),[i]),U=l.useMemo(()=>i.filter(a=>a.type==="external"),[i]),E=l.useMemo(()=>w.filter(a=>!k||a.name.toLowerCase().includes(k.toLowerCase())),[w,k]),P=l.useMemo(()=>H.filter(a=>!k||a.name.toLowerCase().includes(k.toLowerCase())),[H,k]);l.useMemo(()=>U.filter(a=>!k||a.name.toLowerCase().includes(k.toLowerCase())),[U,k]);const y=i.find(a=>a.id===p);l.useEffect(()=>{const a=G=>{c.current&&!c.current.contains(G.target)&&h(null)};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[]),l.useEffect(()=>{const a=G=>{G.key==="Escape"&&h(null)};return document.addEventListener("keydown",a),()=>document.removeEventListener("keydown",a)},[]);const z=a=>{x(!0),R(a),h(null),b("")},T=(a,G)=>{G.stopPropagation(),S===a?(h(null),b("")):(h(a),b(""),setTimeout(()=>{var re;return(re=g.current)==null?void 0:re.focus()},50))},K=a=>{x(!1),A(a),h(null),b("")},X=m&&d==="local",q=m&&d==="api",te=m&&d==="external",I=!m&&(y==null?void 0:y.type)==="self-hosted",W=!m&&(y==null?void 0:y.type)==="github",Q=!m&&(y==null?void 0:y.type)==="external",ee=a=>a==="local"?X?"Self-Hosted Auto":I&&(y==null?void 0:y.name)||"Self-Hosted":a==="api"?q?"GitHub Auto":W&&(y==null?void 0:y.name)||"GitHub":te?"External Auto":Q&&(y==null?void 0:y.name)||"External";return e.jsxs("div",{className:"relative flex items-center gap-1 bg-slate-800/50 rounded-lg p-1 border border-slate-700/50 backdrop-blur-sm",ref:c,children:[e.jsxs("div",{className:"relative flex items-center",children:[e.jsxs("button",{onClick:()=>z("local"),disabled:$,className:`h-7 pl-3 pr-1 flex items-center gap-1.5 rounded-l-md transition-all active:scale-95 text-xs font-medium whitespace-nowrap ${X||I?"bg-emerald-500/20 text-emerald-300":"text-slate-400 hover:text-slate-300 hover:bg-slate-700/30"}`,children:[X?e.jsx(oe,{size:12,className:"text-emerald-400"}):e.jsx("div",{className:"w-2 h-2 rounded-full bg-emerald-500"}),e.jsx("span",{className:"max-w-[80px] truncate",children:ee("local")})]}),e.jsx("button",{onClick:a=>T("local",a),disabled:$,className:`h-7 px-1 flex items-center rounded-r-md transition-all ${X||I?"bg-emerald-500/20 text-emerald-400":"text-slate-500 hover:text-slate-300 hover:bg-slate-700/30"}`,children:e.jsx(Oe,{size:12,className:`transition-transform ${S==="local"?"rotate-180":""}`})}),S==="local"&&w.length>0&&e.jsxs("div",{className:"absolute top-full left-0 mt-1 w-56 bg-slate-800/95 backdrop-blur-md border border-slate-700 rounded-lg shadow-2xl z-[100] overflow-hidden animate-in fade-in slide-in-from-top-1 duration-150",children:[w.length>5&&e.jsx("div",{className:"px-2 py-2 border-b border-slate-700/50",children:e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{size:12,className:"absolute left-2 top-1/2 -translate-y-1/2 text-slate-500"}),e.jsx("input",{ref:g,type:"text",placeholder:"Search...",value:k,onChange:a=>b(a.target.value),className:"w-full pl-7 pr-2 py-1 text-xs bg-slate-700/50 border border-slate-600/50 rounded text-slate-200 placeholder-slate-500 focus:outline-none focus:border-emerald-500/50"})]})}),e.jsxs("button",{onClick:()=>z("local"),className:`w-full px-3 py-2 text-left text-xs font-medium transition-colors flex items-center justify-between ${X?"bg-emerald-500/20 text-emerald-300":"text-slate-300 hover:bg-slate-700/50"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{size:12,className:"text-emerald-400"}),e.jsx("span",{children:"Auto (Smart Fallback)"})]}),X&&e.jsx("span",{className:"text-emerald-400",children:"âœ“"})]}),e.jsx("div",{className:"border-t border-slate-700/50"}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:E.map(a=>e.jsxs("button",{onClick:()=>K(a.id),className:`w-full px-3 py-2 text-left text-xs font-medium transition-colors flex items-center justify-between ${!m&&p===a.id?"bg-emerald-500/20 text-slate-200":"text-slate-300 hover:bg-slate-700/50"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-emerald-500/50"}),e.jsx("span",{children:a.name})]}),!m&&p===a.id&&e.jsx("span",{className:"text-emerald-400",children:"âœ“"})]},a.id))})]})]}),e.jsx("div",{className:"w-px h-5 bg-slate-600/50"}),e.jsxs("div",{className:"relative flex items-center",children:[e.jsxs("button",{onClick:()=>z("api"),disabled:$,className:`h-7 pl-3 pr-1 flex items-center gap-1.5 rounded-l-md transition-all active:scale-95 text-xs font-medium whitespace-nowrap ${q||W?"bg-blue-500/20 text-blue-300":"text-slate-400 hover:text-slate-300 hover:bg-slate-700/30"}`,children:[q?e.jsx(oe,{size:12,className:"text-blue-400"}):e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500"}),e.jsx("span",{className:"max-w-[80px] truncate",children:ee("api")})]}),e.jsx("button",{onClick:a=>T("api",a),disabled:$,className:`h-7 px-1 flex items-center rounded-r-md transition-all ${q||W?"bg-blue-500/20 text-blue-400":"text-slate-500 hover:text-slate-300 hover:bg-slate-700/30"}`,children:e.jsx(Oe,{size:12,className:`transition-transform ${S==="api"?"rotate-180":""}`})}),S==="api"&&H.length>0&&e.jsxs("div",{className:"absolute top-full right-0 mt-1 w-64 bg-slate-800/95 backdrop-blur-md border border-slate-700 rounded-lg shadow-2xl z-[100] overflow-hidden animate-in fade-in slide-in-from-top-1 duration-150",children:[H.length>5&&e.jsx("div",{className:"px-2 py-2 border-b border-slate-700/50",children:e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{size:12,className:"absolute left-2 top-1/2 -translate-y-1/2 text-slate-500"}),e.jsx("input",{ref:g,type:"text",placeholder:"Search models...",value:k,onChange:a=>b(a.target.value),className:"w-full pl-7 pr-2 py-1 text-xs bg-slate-700/50 border border-slate-600/50 rounded text-slate-200 placeholder-slate-500 focus:outline-none focus:border-blue-500/50"})]})}),e.jsxs("button",{onClick:()=>z("api"),className:`w-full px-3 py-2 text-left text-xs font-medium transition-colors flex items-center justify-between ${q?"bg-blue-500/20 text-blue-300":"text-slate-300 hover:bg-slate-700/50"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{size:12,className:"text-blue-400"}),e.jsx("span",{children:"Auto (Smart Fallback)"})]}),q&&e.jsx("span",{className:"text-blue-400",children:"âœ“"})]}),e.jsx("div",{className:"border-t border-slate-700/50"}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:P.map(a=>e.jsxs("button",{onClick:()=>K(a.id),className:`w-full px-3 py-2 text-left text-xs font-medium transition-colors flex items-center justify-between ${!m&&p===a.id?"bg-blue-500/20 text-slate-200":"text-slate-300 hover:bg-slate-700/50"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500/50"}),e.jsx("span",{children:a.name})]}),!m&&p===a.id&&e.jsx("span",{className:"text-blue-400",children:"âœ“"})]},a.id))})]})]})]})}const bt=l.forwardRef(({models:i,selectedModelId:p,onSelectModel:A,githubToken:m,messages:x,setMessages:d,autoMode:R,setAutoMode:$,autoModeScope:S,setAutoModeScope:h,currentResponse:k,setCurrentResponse:b,isGenerating:c,setIsGenerating:g,onModelUsed:w,gesturesActive:H=!1},U)=>{var ze;const[E,P]=l.useState(!1),[y,z]=l.useState(null),[T,K]=l.useState(new Set),[X,q]=l.useState(null),[te,I]=l.useState(null),[W,Q]=l.useState(new Set),[ee,a]=l.useState(""),[G,re]=l.useState(null),ne=l.useRef(new Map);l.useRef(new Map);const Y=l.useRef(null),Se=l.useRef(null),M=l.useRef(null),se=l.useRef(null),ae=l.useRef(new Map),ie=l.useRef(null),ke=l.useRef(null),ce=et(),Pe=((ze=ce==null?void 0:ce.gestureState)==null?void 0:ze.gesture)==="Middle_Finger",{sortModels:Ce,recordRateLimit:Re,recordSuccess:ue}=lt(),de=l.useRef(!1),Fe=t=>{if(!M.current)return t;const r=M.current.scrollHeight-M.current.clientHeight;return Math.max(0,Math.min(r,t))},He=()=>{if(!M.current)return!0;const{scrollTop:t,scrollHeight:r,clientHeight:n}=M.current;return r-t-n<100};l.useImperativeHandle(U,()=>({sendMessage:(t,r)=>{pe(t,r)},setInput:t=>{se.current&&(se.current.value=t,se.current.focus())},stopGeneration:()=>{Ee()},scroll:t=>{if(M.current){de.current=!0;const r=M.current.scrollTop,n=Fe(r-t);M.current.scrollTop=n}}}));const{selectionRect:Me}=nt({containerRef:Se,itemRefs:ae,setSelectedIndices:K});l.useEffect(()=>{M.current&&!de.current&&(M.current.scrollTop=M.current.scrollHeight)},[x,k,c]),l.useEffect(()=>{const t=M.current;if(!t)return;const r=()=>{He()&&(de.current=!1)};return t.addEventListener("scroll",r,{passive:!0}),()=>t.removeEventListener("scroll",r)},[]),l.useEffect(()=>{const t=r=>{var s;if(r.ctrlKey||r.metaKey||r.altKey)return;const n=r.target;n.tagName==="INPUT"||n.tagName==="TEXTAREA"||r.key.length===1&&((s=se.current)==null||s.focus())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]),l.useEffect(()=>{const t=r=>{if((r.metaKey||r.ctrlKey)&&r.key==="a"){const n=r.target;if(n.tagName==="INPUT"||n.tagName==="TEXTAREA")return;r.preventDefault();const s=new Set(x.map((o,f)=>f));K(s);return}if(r.key==="Delete"||r.key==="Backspace"){if(T.size>0){const n=r.target;if(n.tagName==="INPUT"||n.tagName==="TEXTAREA")return;r.preventDefault(),Je()}}else r.key==="Escape"&&K(new Set)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[T,x]);const fe=async(t,r)=>{var n,s,o;try{const f=await we({models:[t],messages:r.map(u=>({role:u.role,content:u.content})),max_tokens:2048,temperature:.7,github_token:m||null},(n=Y.current)==null?void 0:n.signal);let v="";return await ve(f,u=>{var N;if((N=Y.current)!=null&&N.signal.aborted)throw new DOMException("Aborted","AbortError");if(u.event==="error"||u.error){const j=typeof u.error=="string"?u.error:u.content||"Stream failed";throw(j.includes("429")||j.toLowerCase().includes("rate limit")||j.toLowerCase().includes("too many requests"))&&(Re(t),console.log(`[Auto Mode] Rate limit detected for ${t}, trying next model...`)),new Error(j)}else(u.event==="token"||u.content)&&u.content&&(v+=u.content,b(j=>j+u.content))}),ue(t),{success:!0,content:v}}catch(f){if(f.name==="AbortError")throw f;const v=((s=f.message)==null?void 0:s.includes("429"))||((o=f.message)==null?void 0:o.toLowerCase().includes("rate limit"));return v&&Re(t),{success:!1,content:f.message,isRateLimit:v}}},pe=async(t,r=!1)=>{var s,o;if(!t.trim()||c||!R&&!p)return;console.log(`[Chat] Sending message. autoMode=${R}, autoModeScope=${S}, selectedModelId=${p}`);const n={role:"user",content:t};d(f=>[...f,n]),g(!0),b(""),Y.current=new AbortController;try{const f=r?{role:"system",content:`User is hands-free using gesture control. Build an interactive interface to guide them.

Available gesture inputs:
- ðŸ‘ (yes/approve/like)
- ðŸ‘Ž (no/disapprove/dislike)
- ðŸ‘‹ (hi/hello/greeting)
- "ok" (okay/continue)
- "thanks" (thank you)
- "stop" (stop/wait)
- Pointing finger (select UI buttons)

Choose interaction style:
- Simple binary: "Give ðŸ‘ to continue or ðŸ‘Ž to stop" (no JSON needed)
- Complex choices: Use JSON UI buttons (3+ options, or multi-word responses needed)

For JSON UI (when appropriate):
\`\`\`json
{
  "options": [
    {"id": "opt1", "label": "Option 1", "action": "message", "value": "option 1"},
    {"id": "opt2", "label": "Option 2", "action": "message", "value": "option 2"}
  ]
}
\`\`\`

Guidelines:
- Keep response concise (2-3 sentences)
- Use simple gestures for yes/no/continue (more efficient)
- Use JSON UI for 3+ options or complex choices
- Provide 2-4 options max in JSON
- User can point at buttons with index finger`}:null,v=t==="ðŸ–•"||t.includes("middle finger")?{role:"system",content:"The user is showing you their middle finger (gesture). This is a playful interaction. Respond with humorous, over-the-top anger, indignation, or witty comeback. Don't be actually offended, but play along with the 'angry robot' persona."}:null,u=[...x,n].map(j=>({role:j.role,content:j.content})),N=[...f?[f]:[],...v?[v]:[],...u];if(R){const j=i.filter(C=>S==="local"?C.type==="self-hosted":S==="api"?C.type==="github"||C.type==="external":!0),D=i.filter(C=>S==="local"?C.type==="github"||C.type==="external":S==="api"?C.type==="self-hosted":!1),O=Ce(j),L=Ce(D);let F=null,_=!1,B=0;console.log(`[Auto Mode] Starting with ${O.length} primary (${S}) models, ${L.length} fallback models`);for(const C of O){console.log(`[Auto Mode] Trying primary model: ${C.id}`),z(C.id),b("");const J=await fe(C.id,N);if(J.success){console.log(`[Auto Mode] Success with ${C.id}`),d(he=>[...he,{role:"assistant",content:J.content,modelName:C.name,modelId:C.id}]),b(""),z(null),w==null||w(C.id);return}console.log(`[Auto Mode] Failed with ${C.id}: ${(s=J.content)==null?void 0:s.substring(0,100)}`),J.isRateLimit&&B++,F=J.content}if(L.length>0){console.log(`[Auto Mode] All primary models failed, trying ${L.length} fallback models`),_=!0;for(const C of L){console.log(`[Auto Mode] Trying fallback model: ${C.id}`),z(C.id),b("");const J=await fe(C.id,N);if(J.success){console.log(`[Auto Mode] Success with fallback ${C.id}`),d(he=>[...he,{role:"assistant",content:J.content,modelName:C.name,modelId:C.id}]),b(""),z(null),w==null||w(C.id);return}console.log(`[Auto Mode] Fallback failed with ${C.id}: ${(o=J.content)==null?void 0:o.substring(0,100)}`),J.isRateLimit&&B++,F=J.content}}else console.log("[Auto Mode] No fallback models available");console.log(`[Auto Mode] All ${O.length+L.length} models failed (${B} rate limited)`);let V;const Te=O.length+L.length;B>0&&B>=Te?V=`â±ï¸ All ${Te} models are currently rate limited. GitHub Models has strict free tier limits. Try again in a minute, or add your own GitHub token in Settings for higher quota.`:B>0?V=`All models failed (${B} rate limited). Last error: ${F}`:_?V=`All models failed to respond. Last error: ${F}`:V=`All ${S} models failed to respond. Last error: ${F}`,d(C=>[...C,{role:"assistant",content:V,error:!0}]),z(null)}else{if(!p)return;const j=i.find(O=>O.id===p),D=await fe(p,N);D.success?(d(O=>[...O,{role:"assistant",content:D.content,modelName:j==null?void 0:j.name,modelId:p}]),w==null||w(p)):d(O=>[...O,{role:"assistant",content:D.content,modelName:j==null?void 0:j.name,error:!0}])}b("")}catch(f){f.name!=="AbortError"&&d(v=>[...v,{role:"assistant",content:f.message,error:!0}])}finally{g(!1),z(null),Y.current=null}},Ee=()=>{Y.current&&(Y.current.abort(),g(!1),k&&(d(t=>[...t,{role:"assistant",content:k}]),b("")))},Le=async(t,r)=>{if(c||x[t].role!=="assistant")return;let s=t-1;for(;s>=0&&x[s].role!=="user";)s--;if(s<0)return;const o=i.find(v=>v.id===r);if(!o)return;const f=x.slice(0,t).map(v=>({role:v.role,content:v.content}));g(!0),q(t),z(r),d(v=>v.map((u,N)=>N===t?{...u,content:"",modelName:o.name,modelId:r,error:void 0}:u)),Y.current=new AbortController;try{const v=await we({models:[r],messages:f,max_tokens:4096,temperature:.7,github_token:m},Y.current.signal);let u="";await ve(v,N=>{var j;if((j=Y.current)!=null&&j.signal.aborted)throw new DOMException("Aborted","AbortError");if(N.event==="error"||N.error){const D=typeof N.error=="string"?N.error:N.content||"Stream failed";throw new Error(D)}else(N.event==="token"||N.content)&&N.content&&(u+=N.content,d(D=>D.map((O,L)=>L===t?{...O,content:u}:O)))}),ue(r),w==null||w(r)}catch(v){v.name!=="AbortError"&&d(u=>u.map((N,j)=>j===t?{...N,content:v.message,error:!0}:N))}finally{g(!1),q(null),z(null),Y.current=null}},Ae=(t,r)=>{if(!t)return i[0]||null;const n=i.find(v=>v.id===t),s=(n==null?void 0:n.type)||"api",o=i.filter(v=>v.type===s),f=o.findIndex(v=>v.id===t);return f===-1?o[0]||null:r==="prev"?f>0?o[f-1]:o[o.length-1]:f<o.length-1?o[f+1]:o[0]},_e=(t,r)=>{r.stopPropagation(),te===t?(I(null),Q(new Set),a("")):(I(t),Q(new Set),a(""),setTimeout(()=>{var n;return(n=ke.current)==null?void 0:n.focus()},50))},me=l.useCallback(()=>{I(null),Q(new Set),a("")},[]),Be=t=>{Q(r=>{const n=new Set(r);return n.has(t)?n.delete(t):n.add(t),n})},Xe=l.useCallback((t,r)=>{const n=ne.current.get(r);n&&(n.abort(),ne.current.delete(r)),d(s=>s.map((o,f)=>f===t&&o.alternateResponses?{...o,alternateResponses:o.alternateResponses.filter(v=>v.modelId!==r)}:o))},[d]),Ke=l.useCallback(async(t,r=0)=>{var o;const n=x[t];if(!n)return;let s;r===0||!n.alternateResponses?s=n.content:s=((o=n.alternateResponses[r-1])==null?void 0:o.content)||n.content;try{await navigator.clipboard.writeText(s);const f=`${t}-${r}`;re(f),setTimeout(()=>re(null),2e3)}catch(f){console.error("Failed to copy:",f)}},[x]),We=async t=>{if(W.size===0||x[t].role!=="assistant")return;let n=t-1;for(;n>=0&&x[n].role!=="user";)n--;if(n<0)return;const s=x.slice(0,t).map(u=>({role:u.role,content:u.content})),o=Array.from(W),f=o.map(u=>{const N=i.find(j=>j.id===u);return{modelId:u,modelName:(N==null?void 0:N.name)||u,content:"",loading:!0}});d(u=>u.map((N,j)=>j===t?{...N,alternateResponses:[...N.alternateResponses||[],...f]}:N)),I(null),Q(new Set);const v=async u=>{if(!i.find(D=>D.id===u))return;const j=new AbortController;ne.current.set(u,j);try{const D=await we({models:[u],messages:s,max_tokens:4096,temperature:.7,github_token:m},j.signal);let O="";await ve(D,L=>{if(j.signal.aborted)throw new DOMException("Aborted","AbortError");if(L.event==="error"||L.error){const F=typeof L.error=="string"?L.error:L.content||"Stream failed";throw new Error(F)}else(L.event==="token"||L.content)&&L.content&&(O+=L.content,d(F=>F.map((_,B)=>B===t&&_.alternateResponses?{..._,alternateResponses:_.alternateResponses.map(V=>V.modelId===u?{...V,content:O}:V)}:_)))}),d(L=>L.map((F,_)=>_===t&&F.alternateResponses?{...F,alternateResponses:F.alternateResponses.map(B=>B.modelId===u?{...B,loading:!1}:B)}:F)),ue(u)}catch(D){D.name!=="AbortError"&&d(O=>O.map((L,F)=>F===t&&L.alternateResponses?{...L,alternateResponses:L.alternateResponses.map(_=>_.modelId===u?{..._,content:D.message,error:!0,loading:!1}:_)}:L))}finally{ne.current.delete(u)}};o.forEach(u=>v(u))},$e=(t,r)=>{d(n=>n.map((s,o)=>o===t?{...s,activeResponseIndex:r}:s))};l.useEffect(()=>{const t=n=>{ie.current&&!ie.current.contains(n.target)&&me()},r=n=>{n.key==="Escape"&&me()};return te!==null&&(document.addEventListener("mousedown",t),document.addEventListener("keydown",r)),()=>{document.removeEventListener("mousedown",t),document.removeEventListener("keydown",r)}},[te,me]);const Je=()=>{T.size!==0&&(d(t=>t.filter((r,n)=>!T.has(n))),K(new Set))},Z=i.find(t=>t.id===p),xe=R&&y?i.find(t=>t.id===y):Z;return e.jsxs("div",{ref:Se,className:"flex flex-col h-full relative isolate z-[10]",children:[e.jsx(tt,{rect:Me}),e.jsx("div",{ref:M,className:"flex-1 overflow-y-auto p-4 pb-32 chat-scroll relative z-[10] [mask-image:linear-gradient(to_bottom,transparent_0%,black_2rem,black_calc(100%-4rem),transparent_100%)]","data-no-arena-scroll":!0,onClick:t=>{(t.target===t.currentTarget||!t.target.closest("[data-message]"))&&K(new Set)},children:e.jsxs("div",{className:"mx-auto w-full min-h-full flex flex-col space-y-6",style:{maxWidth:"600px"},children:[x.length===0&&e.jsxs("div",{className:"flex-1 flex flex-col items-center text-slate-500 select-none pb-20 relative pt-[30vh]",children:[Pe?e.jsxs("div",{className:"mb-4 relative",children:[e.jsx("div",{className:"absolute inset-0 bg-red-500 blur-xl opacity-50 rounded-full"}),e.jsx(be,{size:72,className:"relative text-red-500"}),e.jsx("div",{className:"absolute -top-2 -right-2 text-3xl",children:"ðŸ’¢"})]}):e.jsx(be,{size:72,className:"mb-4 opacity-50 transition-all duration-300"}),e.jsx("div",{className:"flex flex-col items-center gap-2 mb-4 sticky top-4 z-30",children:e.jsx(ut,{models:i,selectedModelId:p,onSelectModel:A,autoMode:R,setAutoMode:$,autoModeScope:S,setAutoModeScope:h,isGenerating:c})}),!m&&(!R&&(Z==null?void 0:Z.type)==="github"||(Z==null?void 0:Z.type)==="external"||R&&S==="api")&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-md bg-yellow-500/10 border border-yellow-500/20 text-yellow-200 text-xs",children:[e.jsx(ge,{size:11,className:"shrink-0 text-yellow-500"}),e.jsx("span",{children:"Add GitHub token in Settings for dedicated quota"})]})]}),x.map((t,r)=>{const n=t.role==="assistant"&&H&&t.content.includes("```json");return e.jsxs("div",{ref:s=>{s?ae.current.set(r,s):ae.current.delete(r)},className:`flex ${t.role==="user"?"justify-end":n?"flex-col sm:flex-row justify-start items-start gap-4":"justify-start"}`,"data-message":r,onClick:s=>{(s.target===s.currentTarget||s.target.closest("[data-message]")===s.currentTarget)&&K(o=>{const f=new Set(o);return f.has(r)?f.delete(r):f.add(r),f})},children:[e.jsxs("div",{className:`group relative ${n?"w-full sm:flex-1 sm:max-w-[45%]":"max-w-[85%]"} rounded-2xl px-4 pt-3 pb-2 select-none transition-all cursor-pointer ${T.has(r)?"ring-2 ring-blue-500 bg-blue-500/10":""} ${t.role==="user"?"bg-blue-600/20 border border-blue-500/30 text-white rounded-tr-sm":X===r?"rounded-tl-sm":t.error?"bg-red-500/10 border border-red-500/30 text-red-200 rounded-tl-sm":"bg-slate-800/60 border border-slate-700/60 text-slate-200 rounded-tl-sm"}`,style:X===r?{background:"rgba(30, 41, 59, 0.8)",border:"1px solid rgba(251, 191, 36, 0.4)",boxShadow:"0 0 20px rgba(251, 191, 36, 0.15), inset 0 0 30px rgba(251, 191, 36, 0.03)"}:void 0,children:[e.jsxs("div",{className:`flex items-center gap-2 mb-1 text-[10px] font-bold uppercase tracking-wider ${t.role==="user"?"text-blue-300 flex-row-reverse":X===r?"text-amber-400/80":"text-slate-400"}`,children:[t.role==="user"?e.jsx(Ye,{size:12}):X===r?e.jsx("div",{className:"relative flex items-center justify-center",style:{width:"14px",height:"14px"},children:e.jsxs("svg",{width:14,height:14,viewBox:"0 0 24 24",fill:"none",style:{filter:"drop-shadow(0 0 6px rgba(251, 191, 36, 0.55))",animation:"spin 0.6s linear infinite"},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"regenSpinnerGradient",gradientUnits:"userSpaceOnUse",x1:"3",y1:"12",x2:"12",y2:"3",children:[e.jsx("stop",{offset:"0%",stopColor:"#fbbf24",stopOpacity:"1"}),e.jsx("stop",{offset:"60%",stopColor:"#fbbf24",stopOpacity:"0.5"}),e.jsx("stop",{offset:"100%",stopColor:"#fbbf24",stopOpacity:"0"})]})}),e.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:"url(#regenSpinnerGradient)",strokeWidth:"2.5",fill:"none",strokeLinecap:"round"})]})}):e.jsx(be,{size:12}),t.role==="user"?"You":e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:s=>{s.stopPropagation();const o=Ae(t.modelId,"prev");o&&!c&&Le(r,o.id)},disabled:c,className:"p-0.5 rounded hover:bg-slate-700/50 transition-colors disabled:opacity-30",title:"Try previous model",children:e.jsx(qe,{size:10})}),e.jsx("span",{className:"px-1",children:t.modelName||"Assistant"}),e.jsx("button",{onClick:s=>{s.stopPropagation();const o=Ae(t.modelId,"next");o&&!c&&Le(r,o.id)},disabled:c,className:"p-0.5 rounded hover:bg-slate-700/50 transition-colors disabled:opacity-30",title:"Try next model",children:e.jsx(Qe,{size:10})}),e.jsxs("div",{className:"relative ml-1",children:[e.jsx("button",{onClick:s=>_e(r,s),disabled:c,className:"p-0.5 rounded hover:bg-slate-700/50 transition-colors disabled:opacity-30",title:"Compare with other models",children:e.jsx(Ge,{size:10})}),te===r&&e.jsxs("div",{ref:ie,className:"absolute top-full left-0 mt-1 w-64 bg-slate-800/95 backdrop-blur-md border border-slate-700 rounded-lg shadow-2xl z-[100] overflow-hidden animate-in fade-in slide-in-from-top-1 duration-150",onClick:s=>s.stopPropagation(),children:[e.jsx("div",{className:"px-3 py-2 border-b border-slate-700/50",children:e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{size:12,className:"absolute left-2 top-1/2 -translate-y-1/2 text-slate-500"}),e.jsx("input",{ref:ke,type:"text",placeholder:"Search models...",value:ee,onChange:s=>a(s.target.value),className:"w-full pl-7 pr-2 py-1.5 text-xs bg-slate-700/50 border border-slate-600/50 rounded text-slate-200 placeholder-slate-500 focus:outline-none focus:border-blue-500/50"})]})}),e.jsxs("div",{className:"flex gap-1 p-2 border-b border-slate-700/50",children:[e.jsx("button",{onClick:()=>{const s=i.filter(o=>o.type==="self-hosted"&&o.id!==t.modelId).map(o=>o.id);Q(new Set(s))},className:"flex-1 px-2 py-1 text-[10px] rounded bg-emerald-500/20 text-emerald-300 hover:bg-emerald-500/30 transition-colors",children:"All Self-Hosted"}),e.jsx("button",{onClick:()=>{const s=i.filter(o=>o.type==="github"||o.type==="external"&&o.id!==t.modelId).map(o=>o.id);Q(new Set(s))},className:"flex-1 px-2 py-1 text-[10px] rounded bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 transition-colors",children:"All GitHub"})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:i.filter(s=>s.id!==t.modelId).filter(s=>!ee||s.name.toLowerCase().includes(ee.toLowerCase())||s.id.toLowerCase().includes(ee.toLowerCase())).map(s=>e.jsxs("button",{onClick:()=>Be(s.id),className:`w-full px-3 py-1.5 text-left text-xs flex items-center justify-between transition-colors ${W.has(s.id)?"bg-slate-700/50 text-white":"text-slate-300 hover:bg-slate-700/30"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s.type==="self-hosted"?"bg-emerald-500":"bg-blue-500"}`}),e.jsx("span",{children:s.name})]}),W.has(s.id)&&e.jsx(De,{size:12,className:"text-emerald-400"})]},s.id))}),W.size>0&&e.jsx("div",{className:"p-2 border-t border-slate-700/50",children:e.jsxs("button",{onClick:()=>We(r),className:"w-full px-3 py-1.5 text-xs font-medium rounded bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 transition-colors",children:["Compare with ",W.size," model",W.size>1?"s":""]})})]})]})]}),t.error&&e.jsx(ge,{size:12,className:"text-red-400"})]}),t.alternateResponses&&t.alternateResponses.length>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-1.5 mt-2 pt-2 pb-2 mb-1 border-t border-slate-700/30",children:[e.jsx("span",{className:"text-[9px] text-slate-500 uppercase tracking-wider mr-1",children:"Compare:"}),t.alternateResponses.map((s,o)=>e.jsxs("div",{className:"flex items-center",children:[e.jsxs("button",{onClick:f=>{f.stopPropagation(),$e(r,o+1)},className:`px-2 py-0.5 text-[9px] rounded-full transition-colors flex items-center gap-1 ${s.loading?"bg-amber-500/20 text-amber-300 ring-1 ring-amber-500/40":s.error?"bg-red-500/20 text-red-300 ring-1 ring-red-500/40":(t.activeResponseIndex??0)===o+1?"bg-blue-500/30 text-blue-200 ring-1 ring-blue-500/50":"bg-slate-700/40 text-slate-400 hover:text-slate-200 hover:bg-slate-700/60"}`,children:[s.loading&&e.jsx(Ze,{size:8,className:"animate-spin text-amber-400"}),s.error&&e.jsx(ge,{size:8,className:"text-red-400"}),s.modelName]}),s.loading&&e.jsx("button",{onClick:f=>{f.stopPropagation(),Xe(r,s.modelId)},className:"ml-0.5 p-0.5 rounded-full hover:bg-red-500/20 text-slate-500 hover:text-red-400 transition-colors",title:"Cancel",children:e.jsx(Ve,{size:8})})]},s.modelId)),(t.activeResponseIndex??0)>0&&e.jsxs("button",{onClick:s=>{s.stopPropagation(),$e(r,0)},className:"px-2 py-0.5 text-[9px] rounded-full bg-slate-600/40 text-slate-300 hover:bg-slate-600/60 transition-colors",children:["â† Back to ",t.modelName]})]}),e.jsx("div",{className:"prose prose-invert prose-sm max-w-none mt-2",children:(()=>{const s=t.activeResponseIndex??0;if(s===0||!t.alternateResponses)return e.jsx(le,{text:t.role==="user"?t.content:je(t.content)});const o=t.alternateResponses[s-1];return o?e.jsx(le,{text:je(o.content)}):e.jsx(le,{text:je(t.content)})})()}),t.role==="assistant"&&t.content&&e.jsx("button",{onClick:s=>{s.stopPropagation(),Ke(r,t.activeResponseIndex??0)},className:`absolute bottom-2 right-2 p-1.5 rounded-md transition-all z-10 ${G===`${r}-${t.activeResponseIndex??0}`?"bg-emerald-500/20 text-emerald-400":"opacity-0 group-hover:opacity-100 bg-slate-700/70 hover:bg-slate-600/70 text-slate-400"}`,title:G===`${r}-${t.activeResponseIndex??0}`?"Copied!":"Copy response",children:G===`${r}-${t.activeResponseIndex??0}`?e.jsx(De,{size:12}):e.jsx(Ue,{size:12})})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full sm:hidden h-px bg-gradient-to-r from-transparent via-blue-500/30 to-transparent my-3"}),e.jsxs("div",{className:"hidden sm:flex items-center self-stretch py-6",children:[e.jsx("div",{className:"h-full w-px bg-gradient-to-b from-transparent via-blue-500/30 to-transparent"}),e.jsx("div",{className:"w-3 h-px bg-blue-500/30"})]}),e.jsx("div",{className:"w-full sm:flex-1 sm:max-w-[40%]",children:e.jsx(ct,{content:t.content,onSelect:s=>pe(s,!0),isInline:!1})})]})]},r)}),c&&X===null&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"max-w-[85%] rounded-2xl rounded-tl-sm px-4 pt-3 pb-0 text-slate-200 relative",style:{background:"rgba(30, 41, 59, 0.8)",border:"1px solid rgba(251, 191, 36, 0.4)",boxShadow:"0 0 20px rgba(251, 191, 36, 0.15), inset 0 0 30px rgba(251, 191, 36, 0.03)"},children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1 text-[10px] font-bold uppercase tracking-wider text-amber-400/80",children:[e.jsx("div",{className:"relative flex items-center justify-center",style:{width:"14px",height:"14px"},children:e.jsxs("svg",{width:14,height:14,viewBox:"0 0 24 24",fill:"none",style:{filter:"drop-shadow(0 0 6px rgba(251, 191, 36, 0.55))",animation:"spin 0.6s linear infinite"},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"chatSpinnerGradient",gradientUnits:"userSpaceOnUse",x1:"3",y1:"12",x2:"12",y2:"3",children:[e.jsx("stop",{offset:"0%",stopColor:"#fbbf24",stopOpacity:"1"}),e.jsx("stop",{offset:"60%",stopColor:"#fbbf24",stopOpacity:"0.5"}),e.jsx("stop",{offset:"100%",stopColor:"#fbbf24",stopOpacity:"0"})]})}),e.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:"rgba(251, 191, 36, 0.15)",strokeWidth:"2",fill:"none"}),e.jsx("path",{d:"M 12 3 A 9 9 0 1 1 3 12",stroke:"url(#chatSpinnerGradient)",strokeWidth:"2",strokeLinecap:"round",fill:"none"}),e.jsx("circle",{cx:"3",cy:"12",r:"1.4",fill:"#fbbf24"})]})}),(xe==null?void 0:xe.name)||"Assistant"]}),e.jsx("div",{className:"prose prose-invert prose-sm max-w-none",children:e.jsx(le,{text:k})})]})})]})}),e.jsx(rt,{inputRef:se,inputFocused:E,setInputFocused:P,onSendMessage:pe,placeholder:R?"Message (Auto mode - will use auto-selected model)...":Z?`Message ${Z.name}...`:"Select a model from the dock to start chatting...",isGenerating:c,onStop:Ee,className:"fixed bottom-0 left-0 right-0 z-[100] pb-6 px-3 sm:px-4 flex justify-center items-end pointer-events-none transition-all duration-300",style:{paddingBottom:"calc(1.5rem + env(safe-area-inset-bottom))"}})]})});export{bt as default};
