import{r as l,j as e,Z as se,t as Oe,u as je,v as he,T as be,U as Ye,w as qe,x as Qe,y as Ge,p as De,z as Ze,X as Ve,D as Ue}from"./react-vendor-Cr2kZ6Hw.js";import{F as ne}from"./FormattedContent-C59IBQBw.js";import{g as Ie,a as et,S as tt,P as rt,f as ge,s as we}from"./index-CVaR1I6N.js";import"./markdown-BhL5aFst.js";import"./math-render-BeslBgx1.js";import"./syntax-highlight-xu6YVAlF.js";function ve(i,f){const E=Math.min(i.x,f.x),x=Math.min(i.y,f.y),m=Math.max(i.x,f.x),p=Math.max(i.y,f.y);return{left:E,top:x,right:m,bottom:p,width:m-E,height:p-x}}function st(i,f){return!(i.right<f.left||i.left>f.right||i.bottom<f.top||i.top>f.bottom)}function nt({containerRef:i,itemRefs:f,setSelectedIndices:E}){const[x,m]=l.useState(null),p=l.useRef(!1);l.useEffect(()=>{p.current=x!=null},[x]),l.useEffect(()=>{const S=h=>{if(h.button!==0||!i.current)return;const A=h.target;if(!A||A.closest('button, a, input, textarea, select, [role="button"]'))return;const c=i.current.getBoundingClientRect();if(!(h.clientX>=c.left&&h.clientX<=c.right&&h.clientY>=c.top&&h.clientY<=c.bottom))return;const w={x:h.clientX,y:h.clientY};h.preventDefault(),p.current=!0,m({origin:w,current:w,active:!1})};return window.addEventListener("mousedown",S,!0),()=>window.removeEventListener("mousedown",S,!0)},[i]),l.useEffect(()=>{if(!x||!i.current)return;const S=b=>b.preventDefault();document.addEventListener("selectstart",S);const h=b=>{const c={x:b.clientX,y:b.clientY};m(g=>{if(!g)return g;const w=ve(g.origin,c),M=g.active||w.width>2||w.height>2;return{...g,current:c,active:M}})},A=b=>{p.current=!1;const c={x:b.clientX,y:b.clientY};m(g=>{if(!g)return null;const w=ve(g.origin,c);if(g.active&&w.width>1&&w.height>1){const M=[];for(const[Z,R]of f.current.entries()){const j=R.getBoundingClientRect();st({left:w.left,right:w.right,top:w.top,bottom:w.bottom},{left:j.left,right:j.right,top:j.top,bottom:j.bottom})&&M.push(Z)}E(new Set(M))}return null})};return window.addEventListener("mousemove",h),window.addEventListener("mouseup",A),()=>{window.removeEventListener("mousemove",h),window.removeEventListener("mouseup",A),document.removeEventListener("selectstart",S)}},[x,i,f,E]);const C=l.useMemo(()=>{if(!x||!x.active||!i.current)return null;const S=i.current.getBoundingClientRect(),h=ve(x.origin,x.current);return h.width<=0||h.height<=0?null:{left:h.left-S.left,top:h.top-S.top,width:h.width,height:h.height}},[x,i]),$=l.useCallback(()=>{m(null),p.current=!1},[]);return{selectionRect:C,isSelecting:x!=null,dragSelectionActiveRef:p,clearSelection:$}}const ot=6e4;function lt(){const i=l.useRef(new Map),f=l.useRef(null),E=C=>{const $=i.current.get(C);return $?Date.now()-$<ot:!1};return{sortModels:C=>{const $=C.map(c=>({...c,priority:Ie(c.id,c.type||"self-hosted",c.priority),isRateLimited:E(c.id),isLastSuccessful:c.id===f.current})),S=$.filter(c=>!c.isRateLimited),h=$.filter(c=>c.isRateLimited),A=S.sort((c,g)=>c.isLastSuccessful!==g.isLastSuccessful?c.isLastSuccessful?-1:1:c.priority!==g.priority?c.priority-g.priority:c.type!==g.type?c.type==="self-hosted"?-1:1:c.id.localeCompare(g.id)),b=h.sort((c,g)=>c.priority!==g.priority?c.priority-g.priority:c.id.localeCompare(g.id));return[...A,...b]},recordRateLimit:C=>{i.current.set(C,Date.now())},recordSuccess:C=>{f.current=C,i.current.delete(C)},isRecentlyRateLimited:E,getLastSuccessfulModel:()=>f.current}}function at(i){const[f,E]=l.useState([]);return l.useEffect(()=>{const x=i.match(/```json\s*([\s\S]*?)\s*```/);if(x)try{let m=x[1];m=m.replace(/[\\']/g,'"').replace(/,\s*}/g,"}").replace(/,\s*]/g,"]").replace(/}\s*[\\]+\s*$/g,"}").replace(/"\s*"\s*$/g,"").trim();const p=JSON.parse(m);if(p.options&&Array.isArray(p.options)){const C=p.options.filter($=>$.id&&$.label&&$.value);C.length>0?E(C):E([])}}catch(m){console.error("Failed to parse gesture options:",m),E([])}else E([])},[i]),f}function ye(i){return i.replace(/```json[\s\S]*?```/g,"").trim()}const it=1800;function ct({content:i,onSelect:f,isInline:E=!1}){const x=at(i),[m,p]=l.useState(null),[C,$]=l.useState({}),S=l.useRef(0),h=l.useRef(0);l.useEffect(()=>{const R=j=>{var D;const O=(D=j.detail)==null?void 0:D.target;if(O&&O.hasAttribute("data-gesture-option")){const z=O.getAttribute("data-gesture-option");z&&z!==m&&(p(z),A(z))}else m&&(p(null),b())};return window.addEventListener("gesture-hover",R),()=>{window.removeEventListener("gesture-hover",R),b()}},[m]);const A=R=>{b(),S.current=Date.now();const j=()=>{const O=Date.now()-S.current,D=Math.min(O/it*100,100);if($(z=>({...z,[R]:D})),D>=100){const z=x.find(H=>H.id===R);z&&(f(z.value),b())}else h.current=requestAnimationFrame(j)};h.current=requestAnimationFrame(j)},b=()=>{h.current&&cancelAnimationFrame(h.current),$({})},c=R=>{p(R),A(R)},g=()=>{p(null),b()};if(x.length===0)return null;const w=E?"w-full mt-3":"w-full",M=E?"grid grid-cols-2 gap-2":"flex flex-col gap-2.5",Z=R=>E?`relative overflow-hidden rounded-lg font-medium text-xs border transition-all duration-200 text-center min-h-[40px] flex items-center justify-center px-3 py-2 ${R?"bg-blue-500/20 border-blue-500/50 text-white shadow-lg shadow-blue-500/10":"bg-slate-800/60 border-slate-700/60 text-slate-200 hover:bg-slate-800/80 hover:border-slate-700/80"}`:`relative overflow-hidden rounded-xl font-medium text-sm border transition-all duration-200 w-full text-left min-h-[52px] flex items-center px-4 py-3 ${R?"bg-blue-500/20 border-blue-500/50 text-white shadow-lg shadow-blue-500/10 scale-[1.02]":"bg-slate-800/60 border-slate-700/60 text-slate-200 hover:bg-slate-800/80 hover:border-slate-700/80"}`;return e.jsxs("div",{className:w,children:[!E&&e.jsxs("div",{className:"flex items-center gap-2 mb-3 px-1",children:[e.jsx("div",{className:"text-xs font-semibold uppercase tracking-wider text-slate-400",children:"Quick Actions"}),e.jsx("div",{className:"flex-1 h-px bg-gradient-to-r from-slate-700/50 to-transparent"})]}),e.jsx("div",{className:M,children:x.map(R=>{const j=C[R.id]||0,O=m===R.id;return e.jsxs("button",{onClick:()=>f(R.value),onMouseEnter:()=>c(R.id),onMouseLeave:g,"data-gesture-option":R.id,className:Z(O),children:[O&&j>0&&e.jsx("div",{className:"absolute bottom-0 left-0 h-1 bg-gradient-to-r from-blue-400 to-blue-500 transition-all duration-75",style:{width:`${j}%`}}),e.jsx("span",{className:"relative z-10",children:R.label})]},R.id)})})]})}function ut({models:i,selectedModelId:f,onSelectModel:E,autoMode:x,setAutoMode:m,autoModeScope:p,setAutoModeScope:C,isGenerating:$}){const[S,h]=l.useState(null),[A,b]=l.useState(""),c=l.useRef(null),g=l.useRef(null),w=l.useMemo(()=>i.filter(a=>a.type==="self-hosted"),[i]),M=l.useMemo(()=>i.filter(a=>a.type==="github"||a.type==="external"),[i]),Z=l.useMemo(()=>w.filter(a=>!A||a.name.toLowerCase().includes(A.toLowerCase())),[w,A]),R=l.useMemo(()=>M.filter(a=>!A||a.name.toLowerCase().includes(A.toLowerCase())),[M,A]),j=i.find(a=>a.id===f);l.useEffect(()=>{const a=_=>{c.current&&!c.current.contains(_.target)&&h(null)};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[]),l.useEffect(()=>{const a=_=>{_.key==="Escape"&&h(null)};return document.addEventListener("keydown",a),()=>document.removeEventListener("keydown",a)},[]);const O=a=>{m(!0),C(a),h(null),b("")},D=(a,_)=>{_.stopPropagation(),S===a?(h(null),b("")):(h(a),b(""),setTimeout(()=>{var U;return(U=g.current)==null?void 0:U.focus()},50))},z=a=>{m(!1),E(a),h(null),b("")},H=x&&p==="local",W=x&&p==="api",I=!x&&(j==null?void 0:j.type)==="self-hosted",G=!x&&(j==null?void 0:j.type)==="github"||(j==null?void 0:j.type)==="external",V=a=>a==="local"?H?"Self-Hosted Auto":I&&(j==null?void 0:j.name)||"Self-Hosted":W?"GitHub Auto":G&&(j==null?void 0:j.name)||"GitHub";return e.jsxs("div",{className:"relative flex items-center gap-1 bg-slate-800/50 rounded-lg p-1 border border-slate-700/50 backdrop-blur-sm",ref:c,children:[e.jsxs("div",{className:"relative flex items-center",children:[e.jsxs("button",{onClick:()=>O("local"),disabled:$,className:`h-7 pl-3 pr-1 flex items-center gap-1.5 rounded-l-md transition-all active:scale-95 text-xs font-medium whitespace-nowrap ${H||I?"bg-emerald-500/20 text-emerald-300":"text-slate-400 hover:text-slate-300 hover:bg-slate-700/30"}`,children:[H?e.jsx(se,{size:12,className:"text-emerald-400"}):e.jsx("div",{className:"w-2 h-2 rounded-full bg-emerald-500"}),e.jsx("span",{className:"max-w-[80px] truncate",children:V("local")})]}),e.jsx("button",{onClick:a=>D("local",a),disabled:$,className:`h-7 px-1 flex items-center rounded-r-md transition-all ${H||I?"bg-emerald-500/20 text-emerald-400":"text-slate-500 hover:text-slate-300 hover:bg-slate-700/30"}`,children:e.jsx(Oe,{size:12,className:`transition-transform ${S==="local"?"rotate-180":""}`})}),S==="local"&&w.length>0&&e.jsxs("div",{className:"absolute top-full left-0 mt-1 w-56 bg-slate-800/95 backdrop-blur-md border border-slate-700 rounded-lg shadow-2xl z-[100] overflow-hidden animate-in fade-in slide-in-from-top-1 duration-150",children:[w.length>5&&e.jsx("div",{className:"px-2 py-2 border-b border-slate-700/50",children:e.jsxs("div",{className:"relative",children:[e.jsx(je,{size:12,className:"absolute left-2 top-1/2 -translate-y-1/2 text-slate-500"}),e.jsx("input",{ref:g,type:"text",placeholder:"Search...",value:A,onChange:a=>b(a.target.value),className:"w-full pl-7 pr-2 py-1 text-xs bg-slate-700/50 border border-slate-600/50 rounded text-slate-200 placeholder-slate-500 focus:outline-none focus:border-emerald-500/50"})]})}),e.jsxs("button",{onClick:()=>O("local"),className:`w-full px-3 py-2 text-left text-xs font-medium transition-colors flex items-center justify-between ${H?"bg-emerald-500/20 text-emerald-300":"text-slate-300 hover:bg-slate-700/50"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{size:12,className:"text-emerald-400"}),e.jsx("span",{children:"Auto (Smart Fallback)"})]}),H&&e.jsx("span",{className:"text-emerald-400",children:"âœ“"})]}),e.jsx("div",{className:"border-t border-slate-700/50"}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:Z.map(a=>e.jsxs("button",{onClick:()=>z(a.id),className:`w-full px-3 py-2 text-left text-xs font-medium transition-colors flex items-center justify-between ${!x&&f===a.id?"bg-emerald-500/20 text-slate-200":"text-slate-300 hover:bg-slate-700/50"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-emerald-500/50"}),e.jsx("span",{children:a.name})]}),!x&&f===a.id&&e.jsx("span",{className:"text-emerald-400",children:"âœ“"})]},a.id))})]})]}),e.jsx("div",{className:"w-px h-5 bg-slate-600/50"}),e.jsxs("div",{className:"relative flex items-center",children:[e.jsxs("button",{onClick:()=>O("api"),disabled:$,className:`h-7 pl-3 pr-1 flex items-center gap-1.5 rounded-l-md transition-all active:scale-95 text-xs font-medium whitespace-nowrap ${W||G?"bg-blue-500/20 text-blue-300":"text-slate-400 hover:text-slate-300 hover:bg-slate-700/30"}`,children:[W?e.jsx(se,{size:12,className:"text-blue-400"}):e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500"}),e.jsx("span",{className:"max-w-[80px] truncate",children:V("api")})]}),e.jsx("button",{onClick:a=>D("api",a),disabled:$,className:`h-7 px-1 flex items-center rounded-r-md transition-all ${W||G?"bg-blue-500/20 text-blue-400":"text-slate-500 hover:text-slate-300 hover:bg-slate-700/30"}`,children:e.jsx(Oe,{size:12,className:`transition-transform ${S==="api"?"rotate-180":""}`})}),S==="api"&&M.length>0&&e.jsxs("div",{className:"absolute top-full right-0 mt-1 w-64 bg-slate-800/95 backdrop-blur-md border border-slate-700 rounded-lg shadow-2xl z-[100] overflow-hidden animate-in fade-in slide-in-from-top-1 duration-150",children:[M.length>5&&e.jsx("div",{className:"px-2 py-2 border-b border-slate-700/50",children:e.jsxs("div",{className:"relative",children:[e.jsx(je,{size:12,className:"absolute left-2 top-1/2 -translate-y-1/2 text-slate-500"}),e.jsx("input",{ref:g,type:"text",placeholder:"Search models...",value:A,onChange:a=>b(a.target.value),className:"w-full pl-7 pr-2 py-1 text-xs bg-slate-700/50 border border-slate-600/50 rounded text-slate-200 placeholder-slate-500 focus:outline-none focus:border-blue-500/50"})]})}),e.jsxs("button",{onClick:()=>O("api"),className:`w-full px-3 py-2 text-left text-xs font-medium transition-colors flex items-center justify-between ${W?"bg-blue-500/20 text-blue-300":"text-slate-300 hover:bg-slate-700/50"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{size:12,className:"text-blue-400"}),e.jsx("span",{children:"Auto (Smart Fallback)"})]}),W&&e.jsx("span",{className:"text-blue-400",children:"âœ“"})]}),e.jsx("div",{className:"border-t border-slate-700/50"}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:R.map(a=>e.jsxs("button",{onClick:()=>z(a.id),className:`w-full px-3 py-2 text-left text-xs font-medium transition-colors flex items-center justify-between ${!x&&f===a.id?"bg-blue-500/20 text-slate-200":"text-slate-300 hover:bg-slate-700/50"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500/50"}),e.jsx("span",{children:a.name})]}),!x&&f===a.id&&e.jsx("span",{className:"text-blue-400",children:"âœ“"})]},a.id))})]})]})]})}const bt=l.forwardRef(({models:i,selectedModelId:f,onSelectModel:E,githubToken:x,messages:m,setMessages:p,autoMode:C,setAutoMode:$,autoModeScope:S,setAutoModeScope:h,currentResponse:A,setCurrentResponse:b,isGenerating:c,setIsGenerating:g,onModelUsed:w,gesturesActive:M=!1},Z)=>{var ze;const[R,j]=l.useState(!1),[O,D]=l.useState(null),[z,H]=l.useState(new Set),[W,I]=l.useState(null),[G,V]=l.useState(null),[a,_]=l.useState(new Set),[U,te]=l.useState(""),[oe,Ne]=l.useState(null),re=l.useRef(new Map);l.useRef(new Map);const Y=l.useRef(null),Se=l.useRef(null),B=l.useRef(null),ee=l.useRef(null),le=l.useRef(new Map),ae=l.useRef(null),ke=l.useRef(null),ie=et(),Pe=((ze=ie==null?void 0:ie.gestureState)==null?void 0:ze.gesture)==="Middle_Finger",{sortModels:Ce,recordRateLimit:Re,recordSuccess:ce}=lt(),ue=l.useRef(!1),Fe=t=>{if(!B.current)return t;const r=B.current.scrollHeight-B.current.clientHeight;return Math.max(0,Math.min(r,t))},He=()=>{if(!B.current)return!0;const{scrollTop:t,scrollHeight:r,clientHeight:n}=B.current;return r-t-n<100};l.useImperativeHandle(Z,()=>({sendMessage:(t,r)=>{pe(t,r)},setInput:t=>{ee.current&&(ee.current.value=t,ee.current.focus())},stopGeneration:()=>{Le()},scroll:t=>{if(B.current){ue.current=!0;const r=B.current.scrollTop,n=Fe(r-t);B.current.scrollTop=n}}}));const{selectionRect:Me}=nt({containerRef:Se,itemRefs:le,setSelectedIndices:H});l.useEffect(()=>{B.current&&!ue.current&&(B.current.scrollTop=B.current.scrollHeight)},[m,A,c]),l.useEffect(()=>{const t=B.current;if(!t)return;const r=()=>{He()&&(ue.current=!1)};return t.addEventListener("scroll",r,{passive:!0}),()=>t.removeEventListener("scroll",r)},[]),l.useEffect(()=>{const t=r=>{var s;if(r.ctrlKey||r.metaKey||r.altKey)return;const n=r.target;n.tagName==="INPUT"||n.tagName==="TEXTAREA"||r.key.length===1&&((s=ee.current)==null||s.focus())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]),l.useEffect(()=>{const t=r=>{if((r.metaKey||r.ctrlKey)&&r.key==="a"){const n=r.target;if(n.tagName==="INPUT"||n.tagName==="TEXTAREA")return;r.preventDefault();const s=new Set(m.map((o,d)=>d));H(s);return}if(r.key==="Delete"||r.key==="Backspace"){if(z.size>0){const n=r.target;if(n.tagName==="INPUT"||n.tagName==="TEXTAREA")return;r.preventDefault(),Je()}}else r.key==="Escape"&&H(new Set)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[z,m]);const de=async(t,r)=>{var n,s,o;try{const d=await ge({models:[t],messages:r.map(u=>({role:u.role,content:u.content})),max_tokens:2048,temperature:.7,github_token:x||null},(n=Y.current)==null?void 0:n.signal);let v="";return await we(d,u=>{var N;if((N=Y.current)!=null&&N.signal.aborted)throw new DOMException("Aborted","AbortError");if(u.event==="error"||u.error){const y=typeof u.error=="string"?u.error:u.content||"Stream failed";throw(y.includes("429")||y.toLowerCase().includes("rate limit")||y.toLowerCase().includes("too many requests"))&&(Re(t),console.log(`[Auto Mode] Rate limit detected for ${t}, trying next model...`)),new Error(y)}else(u.event==="token"||u.content)&&u.content&&(v+=u.content,b(y=>y+u.content))}),ce(t),{success:!0,content:v}}catch(d){if(d.name==="AbortError")throw d;const v=((s=d.message)==null?void 0:s.includes("429"))||((o=d.message)==null?void 0:o.toLowerCase().includes("rate limit"));return v&&Re(t),{success:!1,content:d.message,isRateLimit:v}}},pe=async(t,r=!1)=>{var s,o;if(!t.trim()||c||!C&&!f)return;console.log(`[Chat] Sending message. autoMode=${C}, autoModeScope=${S}, selectedModelId=${f}`);const n={role:"user",content:t};p(d=>[...d,n]),g(!0),b(""),Y.current=new AbortController;try{const d=r?{role:"system",content:`User is hands-free using gesture control. Build an interactive interface to guide them.

Available gesture inputs:
- ðŸ‘ (yes/approve/like)
- ðŸ‘Ž (no/disapprove/dislike)
- ðŸ‘‹ (hi/hello/greeting)
- "ok" (okay/continue)
- "thanks" (thank you)
- "stop" (stop/wait)
- Pointing finger (select UI buttons)

Choose interaction style:
- Simple binary: "Give ðŸ‘ to continue or ðŸ‘Ž to stop" (no JSON needed)
- Complex choices: Use JSON UI buttons (3+ options, or multi-word responses needed)

For JSON UI (when appropriate):
\`\`\`json
{
  "options": [
    {"id": "opt1", "label": "Option 1", "action": "message", "value": "option 1"},
    {"id": "opt2", "label": "Option 2", "action": "message", "value": "option 2"}
  ]
}
\`\`\`

Guidelines:
- Keep response concise (2-3 sentences)
- Use simple gestures for yes/no/continue (more efficient)
- Use JSON UI for 3+ options or complex choices
- Provide 2-4 options max in JSON
- User can point at buttons with index finger`}:null,v=t==="ðŸ–•"||t.includes("middle finger")?{role:"system",content:"The user is showing you their middle finger (gesture). This is a playful interaction. Respond with humorous, over-the-top anger, indignation, or witty comeback. Don't be actually offended, but play along with the 'angry robot' persona."}:null,u=[...m,n].map(y=>({role:y.role,content:y.content})),N=[...d?[d]:[],...v?[v]:[],...u];if(C){const y=i.filter(k=>S==="local"?k.type==="self-hosted":S==="api"?k.type==="github"||k.type==="external":!0),P=i.filter(k=>S==="local"?k.type==="github"||k.type==="external":S==="api"?k.type==="self-hosted":!1),T=Ce(y),L=Ce(P);let F=null,X=!1,K=0;console.log(`[Auto Mode] Starting with ${T.length} primary (${S}) models, ${L.length} fallback models`);for(const k of T){console.log(`[Auto Mode] Trying primary model: ${k.id}`),D(k.id),b("");const J=await de(k.id,N);if(J.success){console.log(`[Auto Mode] Success with ${k.id}`),p(xe=>[...xe,{role:"assistant",content:J.content,modelName:k.name,modelId:k.id}]),b(""),D(null),w==null||w(k.id);return}console.log(`[Auto Mode] Failed with ${k.id}: ${(s=J.content)==null?void 0:s.substring(0,100)}`),J.isRateLimit&&K++,F=J.content}if(L.length>0){console.log(`[Auto Mode] All primary models failed, trying ${L.length} fallback models`),X=!0;for(const k of L){console.log(`[Auto Mode] Trying fallback model: ${k.id}`),D(k.id),b("");const J=await de(k.id,N);if(J.success){console.log(`[Auto Mode] Success with fallback ${k.id}`),p(xe=>[...xe,{role:"assistant",content:J.content,modelName:k.name,modelId:k.id}]),b(""),D(null),w==null||w(k.id);return}console.log(`[Auto Mode] Fallback failed with ${k.id}: ${(o=J.content)==null?void 0:o.substring(0,100)}`),J.isRateLimit&&K++,F=J.content}}else console.log("[Auto Mode] No fallback models available");console.log(`[Auto Mode] All ${T.length+L.length} models failed (${K} rate limited)`);let Q;const Te=T.length+L.length;K>0&&K>=Te?Q=`â±ï¸ All ${Te} models are currently rate limited. GitHub Models has strict free tier limits. Try again in a minute, or add your own GitHub token in Settings for higher quota.`:K>0?Q=`All models failed (${K} rate limited). Last error: ${F}`:X?Q=`All models failed to respond. Last error: ${F}`:Q=`All ${S} models failed to respond. Last error: ${F}`,p(k=>[...k,{role:"assistant",content:Q,error:!0}]),D(null)}else{if(!f)return;const y=i.find(T=>T.id===f),P=await de(f,N);P.success?(p(T=>[...T,{role:"assistant",content:P.content,modelName:y==null?void 0:y.name,modelId:f}]),w==null||w(f)):p(T=>[...T,{role:"assistant",content:P.content,modelName:y==null?void 0:y.name,error:!0}])}b("")}catch(d){d.name!=="AbortError"&&p(v=>[...v,{role:"assistant",content:d.message,error:!0}])}finally{g(!1),D(null),Y.current=null}},Le=()=>{Y.current&&(Y.current.abort(),g(!1),A&&(p(t=>[...t,{role:"assistant",content:A}]),b("")))},Ae=async(t,r)=>{if(c||m[t].role!=="assistant")return;let s=t-1;for(;s>=0&&m[s].role!=="user";)s--;if(s<0)return;const o=i.find(v=>v.id===r);if(!o)return;const d=m.slice(0,t).map(v=>({role:v.role,content:v.content}));g(!0),I(t),D(r),p(v=>v.map((u,N)=>N===t?{...u,content:"",modelName:o.name,modelId:r,error:void 0}:u)),Y.current=new AbortController;try{const v=await ge({models:[r],messages:d,max_tokens:4096,temperature:.7,github_token:x},Y.current.signal);let u="";await we(v,N=>{var y;if((y=Y.current)!=null&&y.signal.aborted)throw new DOMException("Aborted","AbortError");if(N.event==="error"||N.error){const P=typeof N.error=="string"?N.error:N.content||"Stream failed";throw new Error(P)}else(N.event==="token"||N.content)&&N.content&&(u+=N.content,p(P=>P.map((T,L)=>L===t?{...T,content:u}:T)))}),ce(r),w==null||w(r)}catch(v){v.name!=="AbortError"&&p(u=>u.map((N,y)=>y===t?{...N,content:v.message,error:!0}:N))}finally{g(!1),I(null),D(null),Y.current=null}},Ee=(t,r)=>{if(!t)return i[0]||null;const n=i.find(v=>v.id===t),s=(n==null?void 0:n.type)||"api",o=i.filter(v=>v.type===s),d=o.findIndex(v=>v.id===t);return d===-1?o[0]||null:r==="prev"?d>0?o[d-1]:o[o.length-1]:d<o.length-1?o[d+1]:o[0]},_e=(t,r)=>{r.stopPropagation(),G===t?(V(null),_(new Set),te("")):(V(t),_(new Set),te(""),setTimeout(()=>{var n;return(n=ke.current)==null?void 0:n.focus()},50))},fe=l.useCallback(()=>{V(null),_(new Set),te("")},[]),Be=t=>{_(r=>{const n=new Set(r);return n.has(t)?n.delete(t):n.add(t),n})},Xe=l.useCallback((t,r)=>{const n=re.current.get(r);n&&(n.abort(),re.current.delete(r)),p(s=>s.map((o,d)=>d===t&&o.alternateResponses?{...o,alternateResponses:o.alternateResponses.filter(v=>v.modelId!==r)}:o))},[p]),Ke=l.useCallback(async(t,r=0)=>{var o;const n=m[t];if(!n)return;let s;r===0||!n.alternateResponses?s=n.content:s=((o=n.alternateResponses[r-1])==null?void 0:o.content)||n.content;try{await navigator.clipboard.writeText(s);const d=`${t}-${r}`;Ne(d),setTimeout(()=>Ne(null),2e3)}catch(d){console.error("Failed to copy:",d)}},[m]),We=async t=>{if(a.size===0||m[t].role!=="assistant")return;let n=t-1;for(;n>=0&&m[n].role!=="user";)n--;if(n<0)return;const s=m.slice(0,t).map(u=>({role:u.role,content:u.content})),o=Array.from(a),d=o.map(u=>{const N=i.find(y=>y.id===u);return{modelId:u,modelName:(N==null?void 0:N.name)||u,content:"",loading:!0}});p(u=>u.map((N,y)=>y===t?{...N,alternateResponses:[...N.alternateResponses||[],...d]}:N)),V(null),_(new Set);const v=async u=>{if(!i.find(P=>P.id===u))return;const y=new AbortController;re.current.set(u,y);try{const P=await ge({models:[u],messages:s,max_tokens:4096,temperature:.7,github_token:x},y.signal);let T="";await we(P,L=>{if(y.signal.aborted)throw new DOMException("Aborted","AbortError");if(L.event==="error"||L.error){const F=typeof L.error=="string"?L.error:L.content||"Stream failed";throw new Error(F)}else(L.event==="token"||L.content)&&L.content&&(T+=L.content,p(F=>F.map((X,K)=>K===t&&X.alternateResponses?{...X,alternateResponses:X.alternateResponses.map(Q=>Q.modelId===u?{...Q,content:T}:Q)}:X)))}),p(L=>L.map((F,X)=>X===t&&F.alternateResponses?{...F,alternateResponses:F.alternateResponses.map(K=>K.modelId===u?{...K,loading:!1}:K)}:F)),ce(u)}catch(P){P.name!=="AbortError"&&p(T=>T.map((L,F)=>F===t&&L.alternateResponses?{...L,alternateResponses:L.alternateResponses.map(X=>X.modelId===u?{...X,content:P.message,error:!0,loading:!1}:X)}:L))}finally{re.current.delete(u)}};o.forEach(u=>v(u))},$e=(t,r)=>{p(n=>n.map((s,o)=>o===t?{...s,activeResponseIndex:r}:s))};l.useEffect(()=>{const t=n=>{ae.current&&!ae.current.contains(n.target)&&fe()},r=n=>{n.key==="Escape"&&fe()};return G!==null&&(document.addEventListener("mousedown",t),document.addEventListener("keydown",r)),()=>{document.removeEventListener("mousedown",t),document.removeEventListener("keydown",r)}},[G,fe]);const Je=()=>{z.size!==0&&(p(t=>t.filter((r,n)=>!z.has(n))),H(new Set))},q=i.find(t=>t.id===f),me=C&&O?i.find(t=>t.id===O):q;return e.jsxs("div",{ref:Se,className:"flex flex-col h-full relative isolate z-[10]",children:[e.jsx(tt,{rect:Me}),e.jsx("div",{ref:B,className:"flex-1 overflow-y-auto p-4 pb-32 chat-scroll relative z-[10] [mask-image:linear-gradient(to_bottom,transparent_0%,black_2rem,black_calc(100%-4rem),transparent_100%)]","data-no-arena-scroll":!0,onClick:t=>{(t.target===t.currentTarget||!t.target.closest("[data-message]"))&&H(new Set)},children:e.jsxs("div",{className:"mx-auto w-full min-h-full flex flex-col space-y-6",style:{maxWidth:"600px"},children:[m.length===0&&e.jsxs("div",{className:"flex-1 flex flex-col items-center text-slate-500 select-none pb-20 relative pt-[30vh]",children:[Pe?e.jsxs("div",{className:"mb-4 relative",children:[e.jsx("div",{className:"absolute inset-0 bg-red-500 blur-xl opacity-50 rounded-full"}),e.jsx(he,{size:72,className:"relative text-red-500"}),e.jsx("div",{className:"absolute -top-2 -right-2 text-3xl",children:"ðŸ’¢"})]}):e.jsx(he,{size:72,className:"mb-4 opacity-50 transition-all duration-300"}),e.jsx("div",{className:"flex flex-col items-center gap-2 mb-4 sticky top-4 z-30",children:e.jsx(ut,{models:i,selectedModelId:f,onSelectModel:E,autoMode:C,setAutoMode:$,autoModeScope:S,setAutoModeScope:h,isGenerating:c})}),!x&&(!C&&(q==null?void 0:q.type)==="github"||(q==null?void 0:q.type)==="external"||C&&S==="api")&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-md bg-yellow-500/10 border border-yellow-500/20 text-yellow-200 text-xs",children:[e.jsx(be,{size:11,className:"shrink-0 text-yellow-500"}),e.jsx("span",{children:"Add GitHub token in Settings for dedicated quota"})]})]}),m.map((t,r)=>{const n=t.role==="assistant"&&M&&t.content.includes("```json");return e.jsxs("div",{ref:s=>{s?le.current.set(r,s):le.current.delete(r)},className:`flex ${t.role==="user"?"justify-end":n?"flex-col sm:flex-row justify-start items-start gap-4":"justify-start"}`,"data-message":r,onClick:s=>{(s.target===s.currentTarget||s.target.closest("[data-message]")===s.currentTarget)&&H(o=>{const d=new Set(o);return d.has(r)?d.delete(r):d.add(r),d})},children:[e.jsxs("div",{className:`group relative ${n?"w-full sm:flex-1 sm:max-w-[45%]":"max-w-[85%]"} rounded-2xl px-4 pt-3 pb-2 select-none transition-all cursor-pointer ${z.has(r)?"ring-2 ring-blue-500 bg-blue-500/10":""} ${t.role==="user"?"bg-blue-600/20 border border-blue-500/30 text-white rounded-tr-sm":W===r?"rounded-tl-sm":t.error?"bg-red-500/10 border border-red-500/30 text-red-200 rounded-tl-sm":"bg-slate-800/60 border border-slate-700/60 text-slate-200 rounded-tl-sm"}`,style:W===r?{background:"rgba(30, 41, 59, 0.8)",border:"1px solid rgba(251, 191, 36, 0.4)",boxShadow:"0 0 20px rgba(251, 191, 36, 0.15), inset 0 0 30px rgba(251, 191, 36, 0.03)"}:void 0,children:[e.jsxs("div",{className:`flex items-center gap-2 mb-1 text-[10px] font-bold uppercase tracking-wider ${t.role==="user"?"text-blue-300 flex-row-reverse":W===r?"text-amber-400/80":"text-slate-400"}`,children:[t.role==="user"?e.jsx(Ye,{size:12}):W===r?e.jsx("div",{className:"relative flex items-center justify-center",style:{width:"14px",height:"14px"},children:e.jsxs("svg",{width:14,height:14,viewBox:"0 0 24 24",fill:"none",style:{filter:"drop-shadow(0 0 6px rgba(251, 191, 36, 0.55))",animation:"spin 0.6s linear infinite"},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"regenSpinnerGradient",gradientUnits:"userSpaceOnUse",x1:"3",y1:"12",x2:"12",y2:"3",children:[e.jsx("stop",{offset:"0%",stopColor:"#fbbf24",stopOpacity:"1"}),e.jsx("stop",{offset:"60%",stopColor:"#fbbf24",stopOpacity:"0.5"}),e.jsx("stop",{offset:"100%",stopColor:"#fbbf24",stopOpacity:"0"})]})}),e.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:"url(#regenSpinnerGradient)",strokeWidth:"2.5",fill:"none",strokeLinecap:"round"})]})}):e.jsx(he,{size:12}),t.role==="user"?"You":e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:s=>{s.stopPropagation();const o=Ee(t.modelId,"prev");o&&!c&&Ae(r,o.id)},disabled:c,className:"p-0.5 rounded hover:bg-slate-700/50 transition-colors disabled:opacity-30",title:"Try previous model",children:e.jsx(qe,{size:10})}),e.jsx("span",{className:"px-1",children:t.modelName||"Assistant"}),e.jsx("button",{onClick:s=>{s.stopPropagation();const o=Ee(t.modelId,"next");o&&!c&&Ae(r,o.id)},disabled:c,className:"p-0.5 rounded hover:bg-slate-700/50 transition-colors disabled:opacity-30",title:"Try next model",children:e.jsx(Qe,{size:10})}),e.jsxs("div",{className:"relative ml-1",children:[e.jsx("button",{onClick:s=>_e(r,s),disabled:c,className:"p-0.5 rounded hover:bg-slate-700/50 transition-colors disabled:opacity-30",title:"Compare with other models",children:e.jsx(Ge,{size:10})}),G===r&&e.jsxs("div",{ref:ae,className:"absolute top-full left-0 mt-1 w-64 bg-slate-800/95 backdrop-blur-md border border-slate-700 rounded-lg shadow-2xl z-[100] overflow-hidden animate-in fade-in slide-in-from-top-1 duration-150",onClick:s=>s.stopPropagation(),children:[e.jsx("div",{className:"px-3 py-2 border-b border-slate-700/50",children:e.jsxs("div",{className:"relative",children:[e.jsx(je,{size:12,className:"absolute left-2 top-1/2 -translate-y-1/2 text-slate-500"}),e.jsx("input",{ref:ke,type:"text",placeholder:"Search models...",value:U,onChange:s=>te(s.target.value),className:"w-full pl-7 pr-2 py-1.5 text-xs bg-slate-700/50 border border-slate-600/50 rounded text-slate-200 placeholder-slate-500 focus:outline-none focus:border-blue-500/50"})]})}),e.jsxs("div",{className:"flex gap-1 p-2 border-b border-slate-700/50",children:[e.jsx("button",{onClick:()=>{const s=i.filter(o=>o.type==="self-hosted"&&o.id!==t.modelId).map(o=>o.id);_(new Set(s))},className:"flex-1 px-2 py-1 text-[10px] rounded bg-emerald-500/20 text-emerald-300 hover:bg-emerald-500/30 transition-colors",children:"All Self-Hosted"}),e.jsx("button",{onClick:()=>{const s=i.filter(o=>o.type==="github"||o.type==="external"&&o.id!==t.modelId).map(o=>o.id);_(new Set(s))},className:"flex-1 px-2 py-1 text-[10px] rounded bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 transition-colors",children:"All GitHub"})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:i.filter(s=>s.id!==t.modelId).filter(s=>!U||s.name.toLowerCase().includes(U.toLowerCase())||s.id.toLowerCase().includes(U.toLowerCase())).map(s=>e.jsxs("button",{onClick:()=>Be(s.id),className:`w-full px-3 py-1.5 text-left text-xs flex items-center justify-between transition-colors ${a.has(s.id)?"bg-slate-700/50 text-white":"text-slate-300 hover:bg-slate-700/30"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s.type==="self-hosted"?"bg-emerald-500":"bg-blue-500"}`}),e.jsx("span",{children:s.name})]}),a.has(s.id)&&e.jsx(De,{size:12,className:"text-emerald-400"})]},s.id))}),a.size>0&&e.jsx("div",{className:"p-2 border-t border-slate-700/50",children:e.jsxs("button",{onClick:()=>We(r),className:"w-full px-3 py-1.5 text-xs font-medium rounded bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 transition-colors",children:["Compare with ",a.size," model",a.size>1?"s":""]})})]})]})]}),t.error&&e.jsx(be,{size:12,className:"text-red-400"})]}),t.alternateResponses&&t.alternateResponses.length>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-1.5 mt-2 pt-2 pb-2 mb-1 border-t border-slate-700/30",children:[e.jsx("span",{className:"text-[9px] text-slate-500 uppercase tracking-wider mr-1",children:"Compare:"}),t.alternateResponses.map((s,o)=>e.jsxs("div",{className:"flex items-center",children:[e.jsxs("button",{onClick:d=>{d.stopPropagation(),$e(r,o+1)},className:`px-2 py-0.5 text-[9px] rounded-full transition-colors flex items-center gap-1 ${s.loading?"bg-amber-500/20 text-amber-300 ring-1 ring-amber-500/40":s.error?"bg-red-500/20 text-red-300 ring-1 ring-red-500/40":(t.activeResponseIndex??0)===o+1?"bg-blue-500/30 text-blue-200 ring-1 ring-blue-500/50":"bg-slate-700/40 text-slate-400 hover:text-slate-200 hover:bg-slate-700/60"}`,children:[s.loading&&e.jsx(Ze,{size:8,className:"animate-spin text-amber-400"}),s.error&&e.jsx(be,{size:8,className:"text-red-400"}),s.modelName]}),s.loading&&e.jsx("button",{onClick:d=>{d.stopPropagation(),Xe(r,s.modelId)},className:"ml-0.5 p-0.5 rounded-full hover:bg-red-500/20 text-slate-500 hover:text-red-400 transition-colors",title:"Cancel",children:e.jsx(Ve,{size:8})})]},s.modelId)),(t.activeResponseIndex??0)>0&&e.jsxs("button",{onClick:s=>{s.stopPropagation(),$e(r,0)},className:"px-2 py-0.5 text-[9px] rounded-full bg-slate-600/40 text-slate-300 hover:bg-slate-600/60 transition-colors",children:["â† Back to ",t.modelName]})]}),e.jsx("div",{className:"prose prose-invert prose-sm max-w-none mt-2",children:(()=>{const s=t.activeResponseIndex??0;if(s===0||!t.alternateResponses)return e.jsx(ne,{text:t.role==="user"?t.content:ye(t.content)});const o=t.alternateResponses[s-1];return o?e.jsx(ne,{text:ye(o.content)}):e.jsx(ne,{text:ye(t.content)})})()}),t.role==="assistant"&&t.content&&e.jsx("button",{onClick:s=>{s.stopPropagation(),Ke(r,t.activeResponseIndex??0)},className:`absolute bottom-2 right-2 p-1.5 rounded-md transition-all z-10 ${oe===`${r}-${t.activeResponseIndex??0}`?"bg-emerald-500/20 text-emerald-400":"opacity-0 group-hover:opacity-100 bg-slate-700/70 hover:bg-slate-600/70 text-slate-400"}`,title:oe===`${r}-${t.activeResponseIndex??0}`?"Copied!":"Copy response",children:oe===`${r}-${t.activeResponseIndex??0}`?e.jsx(De,{size:12}):e.jsx(Ue,{size:12})})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full sm:hidden h-px bg-gradient-to-r from-transparent via-blue-500/30 to-transparent my-3"}),e.jsxs("div",{className:"hidden sm:flex items-center self-stretch py-6",children:[e.jsx("div",{className:"h-full w-px bg-gradient-to-b from-transparent via-blue-500/30 to-transparent"}),e.jsx("div",{className:"w-3 h-px bg-blue-500/30"})]}),e.jsx("div",{className:"w-full sm:flex-1 sm:max-w-[40%]",children:e.jsx(ct,{content:t.content,onSelect:s=>pe(s,!0),isInline:!1})})]})]},r)}),c&&W===null&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"max-w-[85%] rounded-2xl rounded-tl-sm px-4 pt-3 pb-0 text-slate-200 relative",style:{background:"rgba(30, 41, 59, 0.8)",border:"1px solid rgba(251, 191, 36, 0.4)",boxShadow:"0 0 20px rgba(251, 191, 36, 0.15), inset 0 0 30px rgba(251, 191, 36, 0.03)"},children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1 text-[10px] font-bold uppercase tracking-wider text-amber-400/80",children:[e.jsx("div",{className:"relative flex items-center justify-center",style:{width:"14px",height:"14px"},children:e.jsxs("svg",{width:14,height:14,viewBox:"0 0 24 24",fill:"none",style:{filter:"drop-shadow(0 0 6px rgba(251, 191, 36, 0.55))",animation:"spin 0.6s linear infinite"},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"chatSpinnerGradient",gradientUnits:"userSpaceOnUse",x1:"3",y1:"12",x2:"12",y2:"3",children:[e.jsx("stop",{offset:"0%",stopColor:"#fbbf24",stopOpacity:"1"}),e.jsx("stop",{offset:"60%",stopColor:"#fbbf24",stopOpacity:"0.5"}),e.jsx("stop",{offset:"100%",stopColor:"#fbbf24",stopOpacity:"0"})]})}),e.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:"rgba(251, 191, 36, 0.15)",strokeWidth:"2",fill:"none"}),e.jsx("path",{d:"M 12 3 A 9 9 0 1 1 3 12",stroke:"url(#chatSpinnerGradient)",strokeWidth:"2",strokeLinecap:"round",fill:"none"}),e.jsx("circle",{cx:"3",cy:"12",r:"1.4",fill:"#fbbf24"})]})}),(me==null?void 0:me.name)||"Assistant"]}),e.jsx("div",{className:"prose prose-invert prose-sm max-w-none",children:e.jsx(ne,{text:A})})]})})]})}),e.jsx(rt,{inputRef:ee,inputFocused:R,setInputFocused:j,onSendMessage:pe,placeholder:C?"Message (Auto mode - will use auto-selected model)...":q?`Message ${q.name}...`:"Select a model from the dock to start chatting...",isGenerating:c,onStop:Le,className:"fixed bottom-0 left-0 right-0 z-[100] pb-6 px-3 sm:px-4 flex justify-center items-end pointer-events-none transition-all duration-300",style:{paddingBottom:"calc(1.5rem + env(safe-area-inset-bottom))"}})]})});export{bt as default};
