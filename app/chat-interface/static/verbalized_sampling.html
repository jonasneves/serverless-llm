<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verbalized Sampling - Unlock LLM Diversity</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #FAFAFA;
      --bg-tertiary: #F3F4F6;
      --text-primary: #111827;
      --text-secondary: #6B7280;
      --border-color: #E5E7EB;
      --accent-color: #1e3a5f;
      --accent-hover: #2c4f7c;
      --direct-color: #EF4444;
      --vs-color: #10B981;
      --prob-badge: #8B5CF6;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-hover) 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
    }

    .logo-title {
      font-weight: 700;
      font-size: 18px;
    }

    .logo-subtitle {
      font-size: 11px;
      opacity: 0.85;
    }

    .modes {
      display: flex;
      gap: 8px;
    }

    .mode-link {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.15s ease;
    }

    .mode-link:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .mode-link.active {
      background: rgba(255, 255, 255, 0.25);
      font-weight: 600;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      padding: 24px;
    }

    .technique-explainer {
      background: linear-gradient(135deg, #EEF2FF 0%, #DBEAFE 100%);
      border: 2px solid #3B82F6;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .technique-explainer h2 {
      font-size: 20px;
      margin-bottom: 12px;
      color: #1E40AF;
    }

    .technique-explainer p {
      color: #1E3A8A;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .technique-explainer .paper-link {
      color: #2563EB;
      text-decoration: none;
      font-weight: 600;
    }

    .input-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .input-group {
      margin-bottom: 16px;
    }

    .input-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .input-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      min-height: 80px;
    }

    .controls {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .control-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .control-item label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .control-item input,
    .control-item select {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
    }

    .generate-btn {
      padding: 12px 32px;
      background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-hover) 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s ease;
      margin-left: auto;
    }

    .generate-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3);
    }

    .generate-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .comparison-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      flex: 1;
    }

    .comparison-side {
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      min-height: 500px;
    }

    .comparison-side.direct {
      border-color: var(--direct-color);
      background: linear-gradient(to bottom, #FEF2F2 0%, white 100%);
    }

    .comparison-side.verbalized {
      border-color: var(--vs-color);
      background: linear-gradient(to bottom, #F0FDF4 0%, white 100%);
    }

    .side-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid currentColor;
    }

    .side-header h3 {
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .side-header.direct { color: var(--direct-color); }
    .side-header.verbalized { color: var(--vs-color); }

    .badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge.problem {
      background: #FEE2E2;
      color: #991B1B;
    }

    .badge.solution {
      background: #D1FAE5;
      color: #065F46;
    }

    .responses-container {
      flex: 1;
      overflow-y: auto;
    }

    .response-item {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .response-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .response-number {
      font-weight: 700;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .probability {
      padding: 4px 8px;
      background: var(--prob-badge);
      color: white;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .response-content {
      line-height: 1.6;
      color: var(--text-primary);
    }

    .diversity-score {
      margin-top: 16px;
      padding: 16px;
      background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
      border: 2px solid var(--vs-color);
      border-radius: 8px;
      text-align: center;
    }

    .diversity-score-label {
      font-size: 13px;
      font-weight: 600;
      color: #065F46;
      margin-bottom: 8px;
    }

    .diversity-score-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--vs-color);
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
      text-align: center;
      padding: 40px;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 1024px) {
      .comparison-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="logo-text">
        <span class="logo-title">Verbalized Sampling</span>
        <span class="logo-subtitle">Unlock LLM Diversity</span>
      </div>
    </div>
    <div class="modes">
      <a href="/" class="mode-link">Arena</a>
      <a href="/discussion" class="mode-link">Discussion</a>
      <a href="/autogen" class="mode-link">AutoGen</a>
      <a href="/diversity" class="mode-link active">Diversity</a>
    </div>
  </header>

  <main>
    <div class="technique-explainer">
      <h2>ðŸŽ¯ Verbalized Sampling: Mitigate Mode Collapse</h2>
      <p>
        <strong>The Problem:</strong> Post-training alignment (RLHF) causes LLMs to suffer from "mode collapse" - 
        they give the same predictable response every time due to typicality bias.
      </p>
      <p>
        <strong>The Solution:</strong> Instead of asking for <em>one response</em>, ask for <em>a distribution of responses</em>. 
        This forces the model to tap into its diverse pre-trained knowledge rather than the narrow post-aligned mode.
      </p>
      <p style="margin-bottom: 0;">
        ðŸ“„ <a href="https://arxiv.org/abs/2411.16641" target="_blank" class="paper-link">Stanford Research Paper</a> Â· 
        Boosts creativity 1.6-2x Â· Increases diversity 25.7% Â· Zero training required!
      </p>
    </div>

    <div class="input-section">
      <div class="input-group">
        <label for="query">Your Query</label>
        <textarea 
          id="query" 
          placeholder="Example: Tell me a joke about coffee"
        ></textarea>
      </div>

      <div class="controls">
        <div class="control-item">
          <label>Model</label>
          <select id="model">
            <option value="qwen2.5-7b">Qwen 2.5-7B</option>
            <option value="phi-3-mini">Phi-3 Mini</option>
            <option value="llama-3.2-3b">Llama 3.2-3B</option>
          </select>
        </div>

        <div class="control-item">
          <label>Num Responses</label>
          <input type="number" id="numResponses" value="5" min="3" max="10" style="width: 80px;">
        </div>

        <div class="control-item">
          <label>Temperature</label>
          <input type="number" id="temperature" value="0.8" min="0" max="2" step="0.1" style="width: 80px;">
        </div>

        <button id="generateBtn" class="generate-btn">Compare Methods</button>
      </div>
    </div>

    <div class="comparison-container">
      <!-- Direct Prompting Side -->
      <div class="comparison-side direct">
        <div class="side-header direct">
          <h3>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            Direct Prompting
          </h3>
          <span class="badge problem">Mode Collapse</span>
        </div>
        <div id="directResponses" class="responses-container">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
            </svg>
            <p>Standard prompting - same response multiple times</p>
          </div>
        </div>
      </div>

      <!-- Verbalized Sampling Side -->
      <div class="comparison-side verbalized">
        <div class="side-header verbalized">
          <h3>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
            Verbalized Sampling
          </h3>
          <span class="badge solution">Diverse Outputs</span>
        </div>
        <div id="verbalizedResponses" class="responses-container">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <p>Asks for distribution - unlocks diverse creativity</p>
          </div>
        </div>
        <div id="diversityScore" style="display: none;" class="diversity-score">
          <div class="diversity-score-label">Diversity Score</div>
          <div class="diversity-score-value">--</div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const generateBtn = document.getElementById('generateBtn');
    const queryInput = document.getElementById('query');
    const modelSelect = document.getElementById('model');
    const numResponsesInput = document.getElementById('numResponses');
    const temperatureInput = document.getElementById('temperature');
    const directResponsesContainer = document.getElementById('directResponses');
    const verbalizedResponsesContainer = document.getElementById('verbalizedResponses');
    const diversityScoreContainer = document.getElementById('diversityScore');

    generateBtn.addEventListener('click', async () => {
      const query = queryInput.value.trim();
      if (!query) {
        alert('Please enter a query');
        return;
      }

      const model = modelSelect.value;
      const numResponses = parseInt(numResponsesInput.value);
      const temperature = parseFloat(temperatureInput.value);

      generateBtn.disabled = true;
      generateBtn.innerHTML = '<span class="loading-spinner"></span> Generating...';

      // Clear previous results
      directResponsesContainer.innerHTML = '<div class="empty-state"><div class="loading-spinner" style="width: 40px; height: 40px; border-width: 4px;"></div><p>Generating direct responses...</p></div>';
      verbalizedResponsesContainer.innerHTML = '<div class="empty-state"><div class="loading-spinner" style="width: 40px; height: 40px; border-width: 4px;"></div><p>Generating verbalized sampling responses...</p></div>';
      diversityScoreContainer.style.display = 'none';

      try {
        // Run both methods in parallel
        await Promise.all([
          generateDirect(query, model, numResponses, temperature),
          generateVerbalized(query, model, numResponses, temperature)
        ]);
      } catch (error) {
        console.error('Error:', error);
        alert('Error generating responses. Check console for details.');
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = 'Compare Methods';
      }
    });

    async function generateDirect(query, model, numResponses, temperature) {
      directResponsesContainer.innerHTML = '';
      
      // Make multiple direct calls
      const responses = [];
      for (let i = 0; i < numResponses; i++) {
        const responseDiv = document.createElement('div');
        responseDiv.className = 'response-item';
        responseDiv.innerHTML = `
          <div class="response-header">
            <span class="response-number">Response ${i + 1}</span>
          </div>
          <div class="response-content"><div class="loading-spinner"></div> Generating...</div>
        `;
        directResponsesContainer.appendChild(responseDiv);

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: [{ role: 'user', content: query }],
              model: model,
              temperature: temperature,
              max_tokens: 512,
              stream: false
            })
          });

          const data = await response.json();
          const content = data.choices[0].message.content;
          responses.push(content);

          responseDiv.querySelector('.response-content').innerHTML = content;
        } catch (error) {
          responseDiv.querySelector('.response-content').innerHTML = `<em style="color: var(--direct-color);">Error: ${error.message}</em>`;
        }
      }
    }

    async function generateVerbalized(query, model, numResponses, temperature) {
      verbalizedResponsesContainer.innerHTML = '<div class="empty-state"><div class="loading-spinner" style="width: 40px; height: 40px; border-width: 4px;"></div><p>Streaming verbalized sampling...</p></div>';

      try {
        const response = await fetch(`/api/verbalized-sampling/stream?model=${model}&num_responses=${numResponses}&temperature=${temperature}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: query })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullResponse = '';
        let isFirstChunk = true;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const event = JSON.parse(line.slice(6));

                if (event.event === 'start') {
                  if (isFirstChunk) {
                    verbalizedResponsesContainer.innerHTML = '';
                    isFirstChunk = false;
                  }
                } else if (event.event === 'chunk') {
                  fullResponse += event.content;
                  // Update display with streaming content
                  verbalizedResponsesContainer.innerHTML = `<div class="response-item"><div class="response-content">${fullResponse}</div></div>`;
                } else if (event.event === 'complete') {
                  // Parse and display structured responses
                  verbalizedResponsesContainer.innerHTML = '';
                  event.parsed_responses.forEach((resp, idx) => {
                    const responseDiv = document.createElement('div');
                    responseDiv.className = 'response-item';
                    responseDiv.innerHTML = `
                      <div class="response-header">
                        <span class="response-number">Response ${idx + 1}</span>
                        ${resp.probability ? `<span class="probability">Prob: ${resp.probability}</span>` : ''}
                      </div>
                      <div class="response-content">${resp.response}</div>
                    `;
                    verbalizedResponsesContainer.appendChild(responseDiv);
                  });

                  // Show diversity score
                  diversityScoreContainer.style.display = 'block';
                  diversityScoreContainer.querySelector('.diversity-score-value').textContent = event.diversity_score.toFixed(2);
                } else if (event.event === 'error') {
                  verbalizedResponsesContainer.innerHTML = `<div class="empty-state"><p style="color: var(--direct-color);">Error: ${event.error}</p></div>`;
                }
              } catch (e) {
                console.error('Error parsing event:', e);
              }
            }
          }
        }
      } catch (error) {
        verbalizedResponsesContainer.innerHTML = `<div class="empty-state"><p style="color: var(--direct-color);">Error: ${error.message}</p></div>`;
      }
    }
  </script>
</body>
</html>

